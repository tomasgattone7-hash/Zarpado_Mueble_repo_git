const CHECKOUT_SHIPPING_STORAGE_KEY="checkoutShippingData",CART_STORAGE_KEY="zarpadoCart",PHONE_PATTERN=/^[0-9+()\-\s]{6,40}$/,EMAIL_PATTERN=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,POSTAL_CODE_PATTERN=/^\d{4}$/,PROD_API_BASE_URL="https://api.zarpadomueble.com",LOCAL_API_BASE_URL="http://localhost:3000";function resolveApiBaseUrl(){if("undefined"==typeof window||!window.location)return PROD_API_BASE_URL;if("string"==typeof window.ZM_API_BASE_URL&&window.ZM_API_BASE_URL.trim())return window.ZM_API_BASE_URL.trim();const e=String(window.location.hostname||"").toLowerCase();return"localhost"===e||"127.0.0.1"===e||"[::1]"===e?LOCAL_API_BASE_URL:PROD_API_BASE_URL}function buildApiUrl(e){if("undefined"!=typeof window&&"function"==typeof window.zmBuildApiUrl)return window.zmBuildApiUrl(e);const t=resolveApiBaseUrl(),i=String(e||"").trim();if(!i)return t;if(/^https?:\/\//i.test(i))return i;return`${t}${i.startsWith("/")?i:`/${i}`}`}const confirmState={cart:[],shippingData:null,shippingQuote:null,processing:!1};function escapeHtml(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function formatArs(e){return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}).format(Number(e)||0)}function normalizePostalCode(e){return String(e||"").replace(/\D/g,"").slice(0,4)}function getStoredJson(e,t){try{const i=localStorage.getItem(e);return i?JSON.parse(i):t}catch{return t}}function getStoredCart(){const e=getStoredJson("zarpadoCart",[]);return Array.isArray(e)?e:[]}function sanitizeCart(e){return Array.isArray(e)?e.map(e=>({id:Number.parseInt(e?.id,10),name:String(e?.name||"").trim(),price:Number.parseInt(e?.price,10),quantity:Number.parseInt(e?.quantity,10),image:String(e?.image||"").trim()})).filter(e=>Number.isInteger(e.id)&&e.id>0&&e.name&&Number.isInteger(e.price)&&e.price>=0&&Number.isInteger(e.quantity)&&e.quantity>0):[]}function getStoredShippingData(){try{const e=sessionStorage.getItem("checkoutShippingData")||localStorage.getItem("checkoutShippingData"),t=JSON.parse(e||"{}");return t&&"object"==typeof t?t:{}}catch{return{}}}function getMissingShippingFields(e){const t={fullName:String(e?.fullName||"").trim(),email:String(e?.email||"").trim().toLowerCase(),phone:String(e?.phone||"").trim(),addressLine:String(e?.addressLine||"").trim(),city:String(e?.city||"").trim(),province:String(e?.province||"").trim(),postalCode:normalizePostalCode(e?.postalCode)},i=[];return t.fullName.length<2&&i.push("nombre completo"),EMAIL_PATTERN.test(t.email)||i.push("email válido"),PHONE_PATTERN.test(t.phone)||i.push("teléfono válido"),t.addressLine.length<4&&i.push("calle y número"),t.city.length<2&&i.push("ciudad"),t.province.length<2&&i.push("provincia"),POSTAL_CODE_PATTERN.test(t.postalCode)||i.push("código postal"),{normalized:t,missing:i}}function splitAddressLine(e){const t=String(e||"").trim().replace(/\s+/g," "),i=t.match(/^(.*?)(?:\s+(\d+[A-Za-z0-9./-]*))$/);return i?{street:String(i[1]||"").trim()||t,streetNumber:String(i[2]||"").trim()||"S/N"}:{street:t,streetNumber:"S/N"}}function setConfirmFeedback(e,t=""){const i=document.getElementById("confirm-feedback");i&&(i.textContent=e||"",i.classList.remove("is-success","is-error","is-loading"),"success"===t&&i.classList.add("is-success"),"error"===t&&i.classList.add("is-error"),"loading"===t&&i.classList.add("is-loading"))}function renderCartItems(e){const t=document.getElementById("confirm-cart-items");t&&(t.innerHTML=e.map(e=>{const t=e.price*e.quantity;return`\n            <article class="checkout-cart-item">\n                <div>\n                    <h3>${escapeHtml(e.name)}</h3>\n                    <p>Cantidad: ${e.quantity}</p>\n                </div>\n                <strong>${formatArs(t)}</strong>\n            </article>\n        `}).join(""))}function renderShippingData(e){const t=document.getElementById("confirm-shipping-data");if(!t)return;const i=[["Nombre",e.fullName],["Email",e.email],["Teléfono",e.phone],["Dirección",e.addressLine],["Ciudad",e.city],["Provincia",e.province],["Código Postal",e.postalCode]];t.innerHTML=i.map(([e,t])=>`\n        <div class="checkout-shipping-row">\n            <dt>${escapeHtml(e)}</dt>\n            <dd>${escapeHtml(t)}</dd>\n        </div>\n    `).join("")}function getSubtotal(e){return e.reduce((e,t)=>e+t.price*t.quantity,0)}function renderTotals(e,t){const i=document.getElementById("confirm-subtotal"),n=document.getElementById("confirm-shipping-cost"),r=document.getElementById("confirm-total");if(i&&(i.textContent=formatArs(e)),n&&(n.textContent=Number.isInteger(t)?formatArs(t):"A cotizar"),r){const i=e+(Number.isInteger(t)?t:0);r.textContent=formatArs(i)}}function renderShippingLabel(e){const t=document.getElementById("confirm-shipping-label");t&&(t.textContent=e)}async function requestShippingQuote(e,t){const i=await fetch(buildApiUrl("/api/delivery/quote"),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({postalCode:e,items:t.map(e=>({id:e.id,quantity:e.quantity,unit_price:e.price}))})});let n={};try{n=await i.json()}catch{n={}}if(!i.ok||!1===n?.ok)throw new Error(String(n?.error||"No pudimos calcular el envío para ese código postal."));const r=Number.parseInt(n?.shippingCost,10);if(!Number.isInteger(r)||r<0)throw new Error("La cotización de envío es inválida.");return{shippingCost:r,shippingLabel:String(n?.shippingLabel||"Envío a domicilio").trim()||"Envío a domicilio"}}function markStepThreeActive(){const e=document.querySelector(".checkout-progress-step.is-active");e&&(e.classList.remove("is-active"),e.classList.add("is-complete"));const t=document.getElementById("checkout-step-payment");t&&(t.classList.add("is-active"),t.setAttribute("aria-current","step"))}function buildCheckoutPayload(){const e=confirmState.shippingData,t=splitAddressLine(e.addressLine);return{items:confirmState.cart.map(e=>({id:e.id,quantity:e.quantity,unit_price:e.price})),paymentMethod:"mercadopago",buyerEmail:e.email,email:e.email,payer:{email:e.email},delivery:{method:"shipping",postalCode:e.postalCode,installationRequested:!1},customer:{fullName:e.fullName,email:e.email,phone:e.phone,address:e.addressLine,street:t.street,streetNumber:t.streetNumber,city:e.city,province:e.province,zip:e.postalCode}}}function disablePayButton(e,t=""){const i=document.getElementById("confirm-and-pay-btn");i&&(i.disabled=e,t&&(i.textContent=t))}async function handleConfirmAndPay(){if(!confirmState.processing)if(confirmState.shippingQuote&&Number.isInteger(confirmState.shippingQuote.shippingCost)){confirmState.processing=!0,disablePayButton(!0,"Procesando..."),setConfirmFeedback("Creando orden de pago segura...","loading");try{const e=await fetch(buildApiUrl("/api/mp/create-preference"),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(buildCheckoutPayload())});let t={};try{t=await e.json()}catch{t={}}if(!e.ok||!1===t?.ok)throw new Error(String(t?.error||"No se pudo iniciar el pago."));const i=String(t?.init_point||"").trim();if(!i)throw new Error("No recibimos la URL de pago de Mercado Pago.");markStepThreeActive(),setConfirmFeedback("Redirigiendo a Mercado Pago...","success"),window.setTimeout(()=>{window.location.href=i},250)}catch(e){setConfirmFeedback(e.message||"No pudimos iniciar el pago en este momento.","error"),disablePayButton(!1,"Confirmar y pagar"),confirmState.processing=!1}}else setConfirmFeedback("No pudimos validar el envío. Revisá tus datos y reintentá.","error")}function redirectWithDelay(e,t){setConfirmFeedback(t,"error"),window.setTimeout(()=>{window.location.href=e},1200)}function initConfirmationStep(){if(!String(window.location.pathname||"").toLowerCase().includes("confirmacion"))return;if(confirmState.cart=sanitizeCart(getStoredCart()),0===confirmState.cart.length)return void redirectWithDelay("/tienda","Tu carrito está vacío. Te llevamos a la tienda.");const{normalized:e,missing:t}=getMissingShippingFields(getStoredShippingData());if(t.length>0)return void redirectWithDelay("/datos-envio","Faltan datos de envío para continuar. Completá el paso 1.");confirmState.shippingData=e,renderCartItems(confirmState.cart),renderShippingData(confirmState.shippingData);const i=getSubtotal(confirmState.cart);renderTotals(i,0),renderShippingLabel("Calculando costo de envío..."),setConfirmFeedback("Validando costo de envío por código postal...","loading"),requestShippingQuote(confirmState.shippingData.postalCode,confirmState.cart).then(e=>{confirmState.shippingQuote=e,renderTotals(i,e.shippingCost),renderShippingLabel(`${e.shippingLabel}. Plazos: 48/72 hs (stock) o 10-20 días hábiles (bajo pedido).`),setConfirmFeedback("Todo listo. Podés confirmar y pagar.","success"),disablePayButton(!1,"Confirmar y pagar")}).catch(e=>{renderTotals(i,null),renderShippingLabel("No pudimos calcular el envío automáticamente para este CP."),setConfirmFeedback(e.message||"No pudimos calcular el envío.","error"),disablePayButton(!0,"Confirmar y pagar")});const n=document.getElementById("confirm-and-pay-btn");n&&(n.disabled=!0,n.addEventListener("click",()=>{handleConfirmAndPay()}))}document.addEventListener("DOMContentLoaded",initConfirmationStep);