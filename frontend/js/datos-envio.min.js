(()=>{const t="checkoutShippingData",e="checkoutState",n=/^[0-9+()\-\s]{6,40}$/,r="https://api.zarpadomueble.com",i="http://localhost:3000";function o(t){return String(t||"").trim().replace(/\/+$/,"")}function a(t){if("undefined"!=typeof window&&"function"==typeof window.zmBuildApiUrl)return window.zmBuildApiUrl(t);const e=function(){if("undefined"==typeof window||!window.location)return o(r);if("string"==typeof window.ZM_API_BASE_URL&&window.ZM_API_BASE_URL.trim())return o(window.ZM_API_BASE_URL);const t=String(window.location.hostname||"").toLowerCase();return"localhost"===t||"127.0.0.1"===t||"[::1]"===t||"file:"===window.location.protocol?o(i):o(r)}(),n=String(t||"").trim();if(!n)return e;if(/^https?:\/\//i.test(n))return n;const a=n.startsWith("/")?n:`/${n}`;return e?`${e}${a}`:a}function s(t){return String(t||"").replace(/\D/g,"").slice(0,4)}function d(){return t=function(){try{const t=JSON.parse(localStorage.getItem("zarpadoCart")||"[]");return Array.isArray(t)?t.filter(t=>Number.isInteger(Number.parseInt(t?.id,10))&&Number.parseInt(t?.quantity,10)>0):[]}catch(t){return[]}}(),Array.isArray(t)?t.map(t=>({id:Number.parseInt(t?.id,10),quantity:Number.parseInt(t?.quantity,10),price:Number.parseInt(t?.price??t?.unit_price,10)||0,name:String(t?.name||t?.title||"").trim(),image:String(t?.image||"").trim()})).filter(t=>Number.isInteger(t.id)&&t.id>0&&Number.isInteger(t.quantity)&&t.quantity>0):[];var t}function c(t,e=""){const n=document.getElementById(`error-${t}`),r=document.getElementById(t);n&&(n.textContent=e,n.hidden=!e),r&&r.setAttribute("aria-invalid",e?"true":"false")}function l(t){["fullName","email","phone","addressLine","city","province","postalCode"].forEach(t=>c(t,""));let e=!1;var r;return t.fullName.length<2&&(c("fullName","Ingresá tu nombre completo."),e=!0),r=t.email,/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/.test(String(r||"").trim())||(c("email","Ingresá un email válido."),e=!0),n.test(t.phone)||(c("phone","Ingresá un teléfono válido."),e=!0),(!t.addressLine||t.addressLine.length<4)&&(c("addressLine","Ingresá calle y número."),e=!0),t.city||(c("city","Ingresá la ciudad."),e=!0),t.province||(c("province","Ingresá la provincia."),e=!0),/^\d{4}$/.test(t.postalCode)||(c("postalCode","Ingresá un código postal válido de 4 dígitos."),e=!0),!e}function u(t,e=""){const n=document.getElementById("shipping-form-feedback");n&&(n.textContent=t||"",n.classList.remove("is-success","is-error","is-loading"),"success"===e&&n.classList.add("is-success"),"error"===e&&n.classList.add("is-error"),"loading"===e&&n.classList.add("is-loading"))}function p(){return!(d().length>0)&&(function(){const t=document.getElementById("shipping-step-form");t&&t.querySelectorAll("input, button, select, textarea").forEach(t=>{(t instanceof HTMLInputElement||t instanceof HTMLButtonElement||t instanceof HTMLSelectElement||t instanceof HTMLTextAreaElement)&&("shipping-step-submit"!==t.id?(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)&&(t.readOnly=!0):t.disabled=!0)})}(),u("Tu carrito está vacío. Te llevamos a la tienda para continuar.","error"),setTimeout(()=>{window.location.href="/tienda"},1200),!0)}async function m(t,n){const r=function(){try{const t=sessionStorage.getItem(e)||localStorage.getItem(e),n=JSON.parse(t||"{}");return n&&"object"==typeof n?n:{}}catch(t){return{}}}();if(0===n.length)throw new Error("El carrito está vacío. Volvé a la tienda para continuar.");const i=Number.parseInt(r?.totals?.subtotal,10),o=[r?.totals?.envio,r?.delivery?.shippingCost,r?.shippingCost].map(t=>Number.parseInt(t,10)).find(t=>Number.isInteger(t)&&t>=0),s=function(t){return t.reduce((t,e)=>t+(Number.parseInt(e.price,10)||0)*(Number.parseInt(e.quantity,10)||0),0)}(n),d=Number.isInteger(i)&&i>0?i:s,c=Number.isInteger(o)&&o>=0?o:0,l=Number.parseInt(r?.totals?.installation,10),u=Number.isInteger(l)&&l>=0?l:0,p=d+c+u,m=await async function(t,e={},n=12e3){if("undefined"==typeof AbortController)return fetch(t,e);const r=new AbortController,i=window.setTimeout(()=>{r.abort()},n),o={...e,signal:r.signal};try{return await fetch(t,o)}finally{window.clearTimeout(i)}}(a("/api/checkout/shipping"),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({fullName:t.fullName,nombre:t.fullName,email:t.email,phone:t.phone,telefono:t.phone,addressLine:t.addressLine,direccion:t.addressLine,city:t.city,ciudad:t.city,province:t.province,provincia:t.province,postalCode:t.postalCode,codigo_postal:t.postalCode,subtotal:d,envio:c,installation:u,total:p,items:n.map(t=>({id:t.id,quantity:t.quantity,unit_price:t.price})),cart:{subtotal:d,envio:c,installation:u,total:p,items:n.map(t=>({id:t.id,quantity:t.quantity,unit_price:t.price}))}})},15e3);let g={};try{g=await m.json()}catch(t){g={}}if(!m.ok||!1===g?.ok)throw new Error(String(g?.error||"No pudimos guardar el pedido."));const f=Number.parseInt(g?.id??g?.pedidoId,10),h=String(g?.orderId||g?.order_id||r?.draftOrderRef||"").trim();return function(t){const n=t&&"object"==typeof t?t:{};try{localStorage.setItem(e,JSON.stringify(n)),sessionStorage.setItem(e,JSON.stringify(n))}catch(t){}}({...r,items:n,totals:{subtotal:Number.parseInt(g?.totals?.subtotal,10)||d,envio:Number.parseInt(g?.totals?.envio,10)||c,installation:Number.parseInt(g?.totals?.installation,10)||u,total:Number.parseInt(g?.totals?.total,10)||p},delivery:{...r.delivery||{},method:"shipping",postalCode:t.postalCode,shippingLabel:String(g?.shippingLabel||r?.delivery?.shippingLabel||""),shippingReady:!0},draftOrderId:Number.isInteger(f)&&f>0?f:null,draftOrderRef:h}),g}document.addEventListener("DOMContentLoaded",()=>{if(!window.location.pathname.toLowerCase().includes("datos-envio"))return;if(p())return;!function(){const t=document.getElementById("postalCode");t&&t.addEventListener("input",()=>{t.value=s(t.value)})}(),function(t){const e=[String(t?.street||"").trim(),String(t?.streetNumber||"").trim()].filter(Boolean).join(" ");["fullName","email","phone","addressLine","city","province","postalCode"].forEach(n=>{const r=document.getElementById(n);if(!r)return;const i=String("addressLine"===n?t?.addressLine||e||"":t?.[n]||"");r.value="postalCode"===n?s(i):i})}(function(){try{const e=sessionStorage.getItem(t)||localStorage.getItem(t),n=JSON.parse(e||"{}");return n&&"object"==typeof n?n:{}}catch(t){return{}}}());try{const t=new URL(window.location.href),e=String(t.searchParams.get("error")||"").trim();e&&(u(e,"error"),t.searchParams.delete("error"),window.history.replaceState({},"",`${t.pathname}${t.search}${t.hash}`))}catch(t){}const e=document.getElementById("shipping-step-form"),n=document.getElementById("shipping-step-submit");e&&n&&e.addEventListener("submit",async e=>{e.preventDefault();const r=function(){const t=document.getElementById("shipping-step-form"),e=new FormData(t);return{fullName:String(e.get("fullName")||"").trim(),email:String(e.get("email")||"").trim().toLowerCase(),phone:String(e.get("phone")||"").trim(),addressLine:String(e.get("addressLine")||"").trim(),city:String(e.get("city")||"").trim(),province:String(e.get("province")||"").trim(),postalCode:s(e.get("postalCode"))}}();if(!l(r))return void u("Revisá los campos marcados para continuar.","error");const i=d();if(0!==i.length){n.disabled=!0,n.textContent="Guardando...",u("Guardando datos de envío...","loading");try{const e={...r,savedAt:(new Date).toISOString()};sessionStorage.setItem(t,JSON.stringify(e)),localStorage.setItem(t,JSON.stringify(e));const n=await m(r,i);u("Datos guardados. Avanzando al paso 2...","success");const o=String(n?.redirectTo||"").trim()||"/confirmacion"+(n?.orderId?`?orderId=${encodeURIComponent(n.orderId)}`:"");setTimeout(()=>{window.location.href=o},350)}catch(t){const e="AbortError"===t?.name?"El servidor tardó demasiado en responder. Intentá nuevamente.":"No pudimos guardar los datos. Intentá nuevamente.";u("AbortError"===t?.name?e:t?.message||e,"error"),n.disabled=!1,n.textContent="Continuar a confirmación"}}else u("El carrito está vacío. Agregá productos para continuar.","error")})})})();