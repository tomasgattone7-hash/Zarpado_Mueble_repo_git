const CHECKOUT_SHIPPING_STORAGE_KEY="checkoutShippingData",CART_STORAGE_KEY="zarpadoCart",PHONE_PATTERN=/^[0-9+()\-\s]{6,40}$/;function getStoredCart(){try{const e=JSON.parse(localStorage.getItem("zarpadoCart")||"[]");return Array.isArray(e)?e.filter(e=>Number.isInteger(Number.parseInt(e?.id,10))&&Number.parseInt(e?.quantity,10)>0):[]}catch(e){return[]}}function getStoredShippingData(){try{const e=sessionStorage.getItem("checkoutShippingData")||localStorage.getItem("checkoutShippingData"),t=JSON.parse(e||"{}");return t&&"object"==typeof t?t:{}}catch(e){return{}}}function setFieldError(e,t=""){const r=document.getElementById(`error-${e}`),n=document.getElementById(e);r&&(r.textContent=t,r.hidden=!t),n&&n.setAttribute("aria-invalid",t?"true":"false")}function clearFieldErrors(){["fullName","email","phone","addressLine","city","province","postalCode"].forEach(e=>setFieldError(e,""))}function isValidEmail(e){return/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/.test(String(e||"").trim())}function normalizePostalCode(e){return String(e||"").replace(/\D/g,"").slice(0,4)}function readFormData(){const e=document.getElementById("shipping-step-form"),t=new FormData(e);return{fullName:String(t.get("fullName")||"").trim(),email:String(t.get("email")||"").trim().toLowerCase(),phone:String(t.get("phone")||"").trim(),addressLine:String(t.get("addressLine")||"").trim(),city:String(t.get("city")||"").trim(),province:String(t.get("province")||"").trim(),postalCode:normalizePostalCode(t.get("postalCode"))}}function validateFormData(e){clearFieldErrors();let t=!1;return e.fullName.length<2&&(setFieldError("fullName","Ingresá tu nombre completo."),t=!0),isValidEmail(e.email)||(setFieldError("email","Ingresá un email válido."),t=!0),PHONE_PATTERN.test(e.phone)||(setFieldError("phone","Ingresá un teléfono válido."),t=!0),(!e.addressLine||e.addressLine.length<4)&&(setFieldError("addressLine","Ingresá calle y número."),t=!0),e.city||(setFieldError("city","Ingresá la ciudad."),t=!0),e.province||(setFieldError("province","Ingresá la provincia."),t=!0),/^\d{4}$/.test(e.postalCode)||(setFieldError("postalCode","Ingresá un código postal válido de 4 dígitos."),t=!0),!t}function prefillForm(e){const t=[String(e?.street||"").trim(),String(e?.streetNumber||"").trim()].filter(Boolean).join(" ");["fullName","email","phone","addressLine","city","province","postalCode"].forEach(r=>{const n=document.getElementById(r);if(!n)return;const i=String("addressLine"===r?e?.addressLine||t||"":e?.[r]||"");n.value="postalCode"===r?normalizePostalCode(i):i})}function setShippingFeedback(e,t=""){const r=document.getElementById("shipping-form-feedback");r&&(r.textContent=e||"",r.classList.remove("is-success","is-error","is-loading"),"success"===t&&r.classList.add("is-success"),"error"===t&&r.classList.add("is-error"),"loading"===t&&r.classList.add("is-loading"))}function bindPostalCodeMask(){const e=document.getElementById("postalCode");e&&e.addEventListener("input",()=>{e.value=normalizePostalCode(e.value)})}function redirectIfCartMissing(){return!(getStoredCart().length>0)&&(setShippingFeedback("Tu carrito está vacío. Te llevamos a la tienda para continuar.","error"),setTimeout(()=>{window.location.href="/tienda"},1200),!0)}document.addEventListener("DOMContentLoaded",()=>{if(!window.location.pathname.toLowerCase().includes("datos-envio"))return;if(redirectIfCartMissing())return;bindPostalCodeMask(),prefillForm(getStoredShippingData());const e=document.getElementById("shipping-step-form"),t=document.getElementById("shipping-step-submit");e&&t&&e.addEventListener("submit",e=>{e.preventDefault();const r=readFormData();if(validateFormData(r)){t.disabled=!0,t.textContent="Guardando...",setShippingFeedback("Guardando datos de envío...","loading");try{const e={...r,savedAt:(new Date).toISOString()};sessionStorage.setItem("checkoutShippingData",JSON.stringify(e)),localStorage.setItem("checkoutShippingData",JSON.stringify(e)),setShippingFeedback("Datos guardados. Avanzando al paso 2...","success"),setTimeout(()=>{window.location.href="/confirmacion"},350)}catch(e){setShippingFeedback("No pudimos guardar los datos. Intentá nuevamente.","error"),t.disabled=!1,t.textContent="Continuar a confirmación"}}else setShippingFeedback("Revisá los campos marcados para continuar.","error")})});