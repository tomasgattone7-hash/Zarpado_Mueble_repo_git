(()=>{const t="checkoutShippingData",e="checkoutState",r=/^[0-9+()\-\s]{6,40}$/,n=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,i=/^\d{4}$/,o="https://api.zarpadomueble.com",a="http://localhost:3000";function s(t){return String(t||"").trim().replace(/\/+$/,"")}function c(t){if("undefined"!=typeof window&&"function"==typeof window.zmBuildApiUrl)return window.zmBuildApiUrl(t);const e=function(){if("undefined"==typeof window||!window.location)return s(o);if("string"==typeof window.ZM_API_BASE_URL&&window.ZM_API_BASE_URL.trim())return s(window.ZM_API_BASE_URL);const t=String(window.location.hostname||"").toLowerCase();return"localhost"===t||"127.0.0.1"===t||"[::1]"===t||"file:"===window.location.protocol?s(a):s(o)}(),r=String(t||"").trim();if(!r)return e;if(/^https?:\/\//i.test(r))return r;const n=r.startsWith("/")?r:`/${r}`;return e?`${e}${n}`:n}async function d(t,e={},r=12e3){if("undefined"==typeof AbortController)return fetch(t,e);const n=new AbortController,i=window.setTimeout(()=>{n.abort()},r),o={...e,signal:n.signal};try{return await fetch(t,o)}finally{window.clearTimeout(i)}}const l={cart:[],shippingData:null,shippingQuote:null,draftOrderId:null,draftOrderRef:"",processing:!1,subtotal:0,shippingCost:0,installationCost:0,total:0};function u(t){return String(t||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function m(t){return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}).format(Number(t)||0)}function p(){const t=function(t,e){try{const r=localStorage.getItem(t);return r?JSON.parse(r):e}catch{return e}}("zarpadoCart",[]);return Array.isArray(t)?t:[]}function g(){try{const t=sessionStorage.getItem(e)||localStorage.getItem(e),r=JSON.parse(t||"{}");return r&&"object"==typeof r?r:{}}catch{return{}}}function f(t){const e=Number.parseInt(t,10);return Number.isInteger(e)?e:null}function h(t){if("number"==typeof t&&Number.isFinite(t)){const e=Math.round(t);return Number.isInteger(e)?e:null}const e=String(t||"").trim();if(!e)return null;const r=e.replace(/\s+/g,"").replace(/ars/gi,"").replace(/\$(?=\d|[.,]\d)/g,"").replace(/\.(?=\d{3}(\D|$))/g,"").replace(/,(?=\d{3}(\D|$))/g,"").replace(",",".").replace(/[^0-9.-]/g,"");if(!r||"-"===r||"."===r||"-."===r)return null;const n=Number.parseFloat(r);return Number.isFinite(n)?Math.round(n):null}function y(t){return Array.isArray(t)?t.map(t=>({id:f(t?.id??t?.productId??t?.itemId),name:String(t?.name||t?.title||t?.productName||"").trim(),price:h(t?.price??t?.unit_price??t?.unitPrice),quantity:f(t?.quantity??t?.qty??t?.cantidad),image:String(t?.image||"").trim()})).filter(t=>Number.isInteger(t.id)&&t.id>0&&Number.isInteger(t.quantity)&&t.quantity>0&&t.quantity<=10):[]}function b(t){const e=function(t){return[String(t?.street||"").trim(),String(t?.streetNumber||"").trim()].filter(Boolean).join(" ").trim()}(t),o={fullName:String(t?.fullName||t?.name||"").trim(),email:String(t?.email||"").trim().toLowerCase(),phone:String(t?.phone||"").trim(),addressLine:String(t?.addressLine||e||"").trim(),city:String(t?.city||t?.cityNeighborhood||"").trim(),province:String(t?.province||"").trim(),postalCode:(a=t?.postalCode||t?.zip,String(a||"").replace(/\D/g,"").slice(0,4))};var a;const s=[];return o.fullName.length<2&&s.push("nombre completo"),n.test(o.email)||s.push("email válido"),r.test(o.phone)||s.push("teléfono válido"),o.addressLine.length<4&&s.push("calle y número"),o.city.length<2&&s.push("ciudad"),o.province.length<2&&s.push("provincia"),i.test(o.postalCode)||s.push("código postal"),{normalized:o,missing:s}}function w(t,e=""){const r=document.getElementById("confirm-feedback");r&&(r.textContent=t||"",r.classList.remove("is-success","is-error","is-loading"),"success"===e&&r.classList.add("is-success"),"error"===e&&r.classList.add("is-error"),"loading"===e&&r.classList.add("is-loading"))}function I(t=!1){C(!(!t&&!l.processing&&Number.isInteger(l.total)&&l.total>0),"Confirmar y pagar")}let S=null;async function N(t){const e=Array.isArray(t)?t:[];if(0===e.length)return[];if(!e.some(t=>!t.name||!Number.isInteger(t.price)||t.price<0))return e;const r=await async function(){if(S)return S;S=(async()=>{const t=await d(c("/api/store/catalog"),{method:"GET",headers:{Accept:"application/json"}},12e3);let e={};try{e=await t.json()}catch{e={}}return(Array.isArray(e?.products)?e.products:[]).reduce((t,e)=>{const r=f(e?.id);return!Number.isInteger(r)||r<=0||(t[r]={name:String(e?.name||"").trim(),image:String(e?.image||"").trim(),price:f(e?.price)}),t},{})})();try{return await S}catch{return S=null,{}}}();return e.map(t=>{const e=r[t.id]||{},n=String(t.name||e.name||"").trim(),i=f(Number.isInteger(t.price)?t.price:e.price);return{...t,name:n,price:i,image:String(t.image||e.image||"").trim()}}).filter(t=>Number.isInteger(t.id)&&t.id>0&&t.name&&Number.isInteger(t.price)&&t.price>=0&&Number.isInteger(t.quantity)&&t.quantity>0&&t.quantity<=10)}function v(){const t=l.shippingData,e=function(t){const e=String(t||"").trim().replace(/\s+/g," "),r=e.match(/^(.*?)(?:\s+(\d+[A-Za-z0-9./-]*))$/);return r?{street:String(r[1]||"").trim()||e,streetNumber:String(r[2]||"").trim()||"S/N"}:{street:e,streetNumber:"S/N"}}(t.addressLine),r=g(),n=String(r?.paymentMethod||"mercadopago").trim()||"mercadopago",i=Number.parseInt(l.draftOrderId,10),o=String(l.draftOrderRef||r?.draftOrderRef||r?.orderId||"").trim();return{items:l.cart.map(t=>({id:t.id,quantity:t.quantity,unit_price:Number.isInteger(t.price)&&t.price>=0?t.price:0})),draftOrderId:Number.isInteger(i)&&i>0?i:void 0,orderId:o||void 0,paymentMethod:n,buyerEmail:t.email,email:t.email,payer:{email:t.email},delivery:{method:"shipping",postalCode:t.postalCode,installationRequested:!1},customer:{fullName:t.fullName,email:t.email,phone:t.phone,address:t.addressLine,street:e.street,streetNumber:e.streetNumber,city:t.city,province:t.province,zip:t.postalCode}}}function C(t,e=""){const r=document.getElementById("confirm-and-pay-btn");r&&(r.disabled=t,e&&(r.textContent=e))}async function A(){if(!l.processing)if(String(l.draftOrderRef||"").trim())if(l.shippingQuote&&Number.isInteger(l.shippingQuote.shippingCost)){l.processing=!0,C(!0,"Procesando..."),w("Creando orden de pago segura...","loading");try{const t=await d(c("/api/mp/create-preference"),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify(v())},15e3);let e={};try{e=await t.json()}catch{e={}}if(!t.ok||!1===e?.ok)throw new Error(String(e?.error||"No se pudo iniciar el pago."));const r=String(e?.init_point||"").trim();if(!r)throw new Error("No recibimos la URL de pago de Mercado Pago.");!function(){const t=document.querySelector(".checkout-progress-step.is-active");t&&(t.classList.remove("is-active"),t.classList.add("is-complete"));const e=document.getElementById("checkout-step-payment");e&&(e.classList.add("is-active"),e.setAttribute("aria-current","step"))}(),w("Redirigiendo a Mercado Pago...","success"),window.setTimeout(()=>{window.location.href=r},250)}catch(t){const e="AbortError"===t?.name?"El servidor demoró en responder. Probá nuevamente.":"No pudimos iniciar el pago en este momento.";w("AbortError"===t?.name?e:t?.message||e,"error"),l.processing=!1,I(!1)}}else w("No pudimos validar el envío. Revisá tus datos y reintentá.","error");else w("No encontramos un pedido draft válido. Volvé al paso 1 e intentá nuevamente.","error")}function E(t,e){w(e,"error"),window.setTimeout(()=>{window.location.href=t},1200)}async function L(){if(!String(window.location.pathname||"").toLowerCase().includes("confirmacion"))return;const r=g(),n=function(t){return y(t?.items)}(r),i=y(p());if(l.cart=await N(n.length>0?n:i),0===l.cart.length)return void E("/tienda","Tu carrito está vacío. Te llevamos a la tienda.");const o=function(){try{const t=new URLSearchParams(window.location.search||"");return String(t.get("orderId")||t.get("order_id")||"").trim()}catch{return""}}(),a=String(r?.draftOrderRef||r?.orderId||"").trim(),s=o||a;let f=null;try{f=await async function(t){const e=t?`?orderId=${encodeURIComponent(t)}`:"",r=[`/api/checkout/summary${e}`,`/api/checkout/confirmacion${e}`];for(const t of r){const e=await d(c(t),{method:"GET",headers:{Accept:"application/json"},credentials:"include"},12e3);let r={};try{r=await e.json()}catch{r={}}if(!e.ok||!1===r?.ok){const n=new Error(String(r?.error||"No pudimos recuperar el pedido en curso."));if(n.redirectTo=String(r?.redirectTo||"").trim(),404===e.status&&t.includes("/api/checkout/summary"))continue;throw n}const n=r?.pedido&&"object"==typeof r.pedido?r.pedido:null;if(n)return n}throw new Error("No recibimos los datos del pedido para confirmar.")}(s)}catch(t){return void E(String(t?.redirectTo||"").trim()||"/datos-envio",t?.message||"No encontramos un pedido en curso. Completá primero el paso 1.")}const S=Number.parseInt(f?.id,10);if(l.draftOrderId=Number.isInteger(S)&&S>0?S:null,l.draftOrderRef=String(f?.orderId||s||"").trim(),!o&&l.draftOrderRef&&window.history?.replaceState){const t=`/confirmacion?orderId=${encodeURIComponent(l.draftOrderRef)}`;window.history.replaceState({},"",t)}const v=f?.shipping&&"object"==typeof f.shipping?f.shipping:{},{normalized:C,missing:L}=b(v);if(L.length>0)return void E("/datos-envio","El pedido guardado no tiene datos de envío completos. Completá nuevamente el paso 1.");l.shippingData=C;const O=h(f?.totals?.subtotal),R=h(f?.totals?.envio),$=h(f?.totals?.total),B=h(f?.totals?.installation);if(!Number.isInteger(O)||O<0||!Number.isInteger(R)||R<0)return void E("/datos-envio","Los totales del pedido son inválidos. Reintentá el paso 1.");const T=Number.isInteger(B)&&B>=0?B:Math.max(0,(Number.isInteger($)&&$>=0?$:O+R)-O-R),k=String(f?.shippingLabel||"Envío a domicilio").trim()||"Envío a domicilio";l.shippingQuote={shippingCost:R,installationCost:T,shippingLabel:k},function(t){const e=document.getElementById("confirm-cart-items");e&&(e.innerHTML=t.map(t=>{const e=Number.isInteger(t.price)&&t.price>=0?t.price:0,r=Number.isInteger(t.quantity)?t.quantity:0,n=e*r;return`\n            <article class="checkout-cart-item">\n                <div>\n                    <h3>${u(t.name)}</h3>\n                    <p>Cantidad: ${r}</p>\n                    <p>Precio unitario: ${m(e)}</p>\n                </div>\n                <strong>${m(n)}</strong>\n            </article>\n        `}).join(""))}(l.cart),function(t){const e=document.getElementById("confirm-shipping-data");if(!e)return;const r=[["Nombre",t.fullName],["Email",t.email],["Teléfono",t.phone],["Dirección",t.addressLine],["Ciudad",t.city],["Provincia",t.province],["Código Postal",t.postalCode]];e.innerHTML=r.map(([t,e])=>`\n        <div class="checkout-shipping-row">\n            <dt>${u(t)}</dt>\n            <dd>${u(e)}</dd>\n        </div>\n    `).join("")}(l.shippingData),function(t,e,r=0){const n=document.getElementById("confirm-subtotal"),i=document.getElementById("confirm-shipping-cost"),o=document.getElementById("confirm-installation-cost"),a=document.getElementById("confirm-installation-row"),s=document.getElementById("confirm-total"),c=Math.max(0,Math.round(Number(t)||0)),d=Number.isInteger(e)&&e>=0?e:0,u=Number.isInteger(r)&&r>=0?r:0,p=c+d+u;l.subtotal=c,l.shippingCost=d,l.installationCost=u,l.total=p,n&&(n.textContent=m(c)),i&&(i.textContent=m(d)),a&&(a.hidden=u<=0),o&&(o.textContent=m(u)),s&&(s.textContent=m(p))}(O,R,T),function(t){const e=document.getElementById("confirm-shipping-label");e&&(e.textContent=t)}(`${k}. Plazos: 48/72 hs (stock) o 10-20 días hábiles (bajo pedido).`),w("Pedido cargado desde base de datos. Podés confirmar y pagar.","success"),I(!1);const q={...l.shippingData,savedAt:(new Date).toISOString()};try{sessionStorage.setItem(t,JSON.stringify(q)),localStorage.setItem(t,JSON.stringify(q))}catch{}!function(t){const r=t&&"object"==typeof t?t:{};try{sessionStorage.setItem(e,JSON.stringify(r)),localStorage.setItem(e,JSON.stringify(r))}catch{}}({...r,items:l.cart,totals:{subtotal:l.subtotal,envio:l.shippingCost,installation:l.installationCost,total:l.total},delivery:{...r.delivery||{},method:"shipping",postalCode:l.shippingData.postalCode,shippingLabel:k,shippingReady:!0},draftOrderId:l.draftOrderId,draftOrderRef:l.draftOrderRef});const P=document.getElementById("confirm-and-pay-btn");P&&(I(!1),P.addEventListener("click",()=>{A()}))}document.addEventListener("DOMContentLoaded",()=>{L().catch(()=>{E("/tienda","No pudimos cargar la confirmación. Te llevamos a la tienda.")})})})();