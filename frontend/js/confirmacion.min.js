const CHECKOUT_SHIPPING_STORAGE_KEY="checkoutShippingData",CART_STORAGE_KEY="zarpadoCart",PHONE_PATTERN=/^[0-9+()\-\s]{6,40}$/,EMAIL_PATTERN=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,POSTAL_CODE_PATTERN=/^\d{4}$/,PROD_API_BASE_URL="https://api.zarpadomueble.com",LOCAL_API_BASE_URL="http://localhost:3000",DEFAULT_FETCH_TIMEOUT_MS=12e3;function normalizeApiBaseUrl(e){return String(e||"").trim().replace(/\/+$/,"")}function resolveApiBaseUrl(){if("undefined"==typeof window||!window.location)return normalizeApiBaseUrl(PROD_API_BASE_URL);if("string"==typeof window.ZM_API_BASE_URL&&window.ZM_API_BASE_URL.trim())return normalizeApiBaseUrl(window.ZM_API_BASE_URL);const e=String(window.location.hostname||"").toLowerCase();return"localhost"===e||"127.0.0.1"===e||"[::1]"===e||"file:"===window.location.protocol?normalizeApiBaseUrl(LOCAL_API_BASE_URL):normalizeApiBaseUrl(PROD_API_BASE_URL)}function buildApiUrl(e){if("undefined"!=typeof window&&"function"==typeof window.zmBuildApiUrl)return window.zmBuildApiUrl(e);const t=resolveApiBaseUrl(),i=String(e||"").trim();if(!i)return t;if(/^https?:\/\//i.test(i))return i;const r=i.startsWith("/")?i:`/${i}`;return t?`${t}${r}`:r}async function fetchWithTimeout(e,t={},i=12e3){if("undefined"==typeof AbortController)return fetch(e,t);const r=new AbortController,n=window.setTimeout(()=>{r.abort()},i),a={...t,signal:r.signal};try{return await fetch(e,a)}finally{window.clearTimeout(n)}}const confirmState={cart:[],shippingData:null,shippingQuote:null,processing:!1};function escapeHtml(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function formatArs(e){return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}).format(Number(e)||0)}function normalizePostalCode(e){return String(e||"").replace(/\D/g,"").slice(0,4)}function getStoredJson(e,t){try{const i=localStorage.getItem(e);return i?JSON.parse(i):t}catch{return t}}function getStoredCart(){const e=getStoredJson("zarpadoCart",[]);return Array.isArray(e)?e:[]}function parseCartInteger(e){const t=Number.parseInt(e,10);return Number.isInteger(t)?t:null}function sanitizeCart(e){return Array.isArray(e)?e.map(e=>({id:parseCartInteger(e?.id??e?.productId??e?.itemId),name:String(e?.name||e?.title||e?.productName||"").trim(),price:parseCartInteger(e?.price??e?.unit_price??e?.unitPrice),quantity:parseCartInteger(e?.quantity??e?.qty??e?.cantidad),image:String(e?.image||"").trim()})).filter(e=>Number.isInteger(e.id)&&e.id>0&&Number.isInteger(e.quantity)&&e.quantity>0&&e.quantity<=10):[]}function getStoredShippingData(){try{const e=sessionStorage.getItem("checkoutShippingData")||localStorage.getItem("checkoutShippingData"),t=JSON.parse(e||"{}");return t&&"object"==typeof t?t:{}}catch{return{}}}function buildLegacyAddressLine(e){return[String(e?.street||"").trim(),String(e?.streetNumber||"").trim()].filter(Boolean).join(" ").trim()}function getMissingShippingFields(e){const t=buildLegacyAddressLine(e),i={fullName:String(e?.fullName||e?.name||"").trim(),email:String(e?.email||"").trim().toLowerCase(),phone:String(e?.phone||"").trim(),addressLine:String(e?.addressLine||t||"").trim(),city:String(e?.city||e?.cityNeighborhood||"").trim(),province:String(e?.province||"").trim(),postalCode:normalizePostalCode(e?.postalCode||e?.zip)},r=[];return i.fullName.length<2&&r.push("nombre completo"),EMAIL_PATTERN.test(i.email)||r.push("email válido"),PHONE_PATTERN.test(i.phone)||r.push("teléfono válido"),i.addressLine.length<4&&r.push("calle y número"),i.city.length<2&&r.push("ciudad"),i.province.length<2&&r.push("provincia"),POSTAL_CODE_PATTERN.test(i.postalCode)||r.push("código postal"),{normalized:i,missing:r}}function splitAddressLine(e){const t=String(e||"").trim().replace(/\s+/g," "),i=t.match(/^(.*?)(?:\s+(\d+[A-Za-z0-9./-]*))$/);return i?{street:String(i[1]||"").trim()||t,streetNumber:String(i[2]||"").trim()||"S/N"}:{street:t,streetNumber:"S/N"}}function setConfirmFeedback(e,t=""){const i=document.getElementById("confirm-feedback");i&&(i.textContent=e||"",i.classList.remove("is-success","is-error","is-loading"),"success"===t&&i.classList.add("is-success"),"error"===t&&i.classList.add("is-error"),"loading"===t&&i.classList.add("is-loading"))}function renderCartItems(e){const t=document.getElementById("confirm-cart-items");t&&(t.innerHTML=e.map(e=>{const t=e.price*e.quantity;return`\n            <article class="checkout-cart-item">\n                <div>\n                    <h3>${escapeHtml(e.name)}</h3>\n                    <p>Cantidad: ${e.quantity}</p>\n                </div>\n                <strong>${formatArs(t)}</strong>\n            </article>\n        `}).join(""))}function renderShippingData(e){const t=document.getElementById("confirm-shipping-data");if(!t)return;const i=[["Nombre",e.fullName],["Email",e.email],["Teléfono",e.phone],["Dirección",e.addressLine],["Ciudad",e.city],["Provincia",e.province],["Código Postal",e.postalCode]];t.innerHTML=i.map(([e,t])=>`\n        <div class="checkout-shipping-row">\n            <dt>${escapeHtml(e)}</dt>\n            <dd>${escapeHtml(t)}</dd>\n        </div>\n    `).join("")}function getSubtotal(e){return e.reduce((e,t)=>e+t.price*t.quantity,0)}function renderTotals(e,t){const i=document.getElementById("confirm-subtotal"),r=document.getElementById("confirm-shipping-cost"),n=document.getElementById("confirm-total");if(i&&(i.textContent=formatArs(e)),r&&(r.textContent=Number.isInteger(t)?formatArs(t):"A cotizar"),n){const i=e+(Number.isInteger(t)?t:0);n.textContent=formatArs(i)}}function renderShippingLabel(e){const t=document.getElementById("confirm-shipping-label");t&&(t.textContent=e)}let catalogMapPromise=null;async function getCatalogMap(){if(catalogMapPromise)return catalogMapPromise;catalogMapPromise=(async()=>{const e=await fetchWithTimeout(buildApiUrl("/api/store/catalog"),{method:"GET",headers:{Accept:"application/json"}},12e3);let t={};try{t=await e.json()}catch{t={}}return(Array.isArray(t?.products)?t.products:[]).reduce((e,t)=>{const i=parseCartInteger(t?.id);return!Number.isInteger(i)||i<=0||(e[i]={name:String(t?.name||"").trim(),image:String(t?.image||"").trim(),price:parseCartInteger(t?.price)}),e},{})})();try{return await catalogMapPromise}catch{return catalogMapPromise=null,{}}}async function hydrateCartItems(e){const t=Array.isArray(e)?e:[];if(0===t.length)return[];if(!t.some(e=>!e.name||!Number.isInteger(e.price)||e.price<0))return t;const i=await getCatalogMap();return t.map(e=>{const t=i[e.id]||{},r=String(e.name||t.name||"").trim(),n=parseCartInteger(Number.isInteger(e.price)?e.price:t.price);return{...e,name:r,price:n,image:String(e.image||t.image||"").trim()}}).filter(e=>Number.isInteger(e.id)&&e.id>0&&e.name&&Number.isInteger(e.price)&&e.price>=0&&Number.isInteger(e.quantity)&&e.quantity>0&&e.quantity<=10)}async function requestShippingQuote(e,t){const i=await fetchWithTimeout(buildApiUrl("/api/delivery/quote"),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({postalCode:e,items:t.map(e=>({id:e.id,quantity:e.quantity,unit_price:e.price}))})},12e3);let r={};try{r=await i.json()}catch{r={}}if(!i.ok||!1===r?.ok)throw new Error(String(r?.error||"No pudimos calcular el envío para ese código postal."));const n=Number.parseInt(r?.shippingCost,10);if(!Number.isInteger(n)||n<0)throw new Error("La cotización de envío es inválida.");return{shippingCost:n,shippingLabel:String(r?.shippingLabel||"Envío a domicilio").trim()||"Envío a domicilio"}}function markStepThreeActive(){const e=document.querySelector(".checkout-progress-step.is-active");e&&(e.classList.remove("is-active"),e.classList.add("is-complete"));const t=document.getElementById("checkout-step-payment");t&&(t.classList.add("is-active"),t.setAttribute("aria-current","step"))}function buildCheckoutPayload(){const e=confirmState.shippingData,t=splitAddressLine(e.addressLine);return{items:confirmState.cart.map(e=>({id:e.id,quantity:e.quantity,unit_price:e.price})),paymentMethod:"mercadopago",buyerEmail:e.email,email:e.email,payer:{email:e.email},delivery:{method:"shipping",postalCode:e.postalCode,installationRequested:!1},customer:{fullName:e.fullName,email:e.email,phone:e.phone,address:e.addressLine,street:t.street,streetNumber:t.streetNumber,city:e.city,province:e.province,zip:e.postalCode}}}function disablePayButton(e,t=""){const i=document.getElementById("confirm-and-pay-btn");i&&(i.disabled=e,t&&(i.textContent=t))}async function handleConfirmAndPay(){if(!confirmState.processing)if(confirmState.shippingQuote&&Number.isInteger(confirmState.shippingQuote.shippingCost)){confirmState.processing=!0,disablePayButton(!0,"Procesando..."),setConfirmFeedback("Creando orden de pago segura...","loading");try{const e=await fetchWithTimeout(buildApiUrl("/api/mp/create-preference"),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(buildCheckoutPayload())},15e3);let t={};try{t=await e.json()}catch{t={}}if(!e.ok||!1===t?.ok)throw new Error(String(t?.error||"No se pudo iniciar el pago."));const i=String(t?.init_point||"").trim();if(!i)throw new Error("No recibimos la URL de pago de Mercado Pago.");markStepThreeActive(),setConfirmFeedback("Redirigiendo a Mercado Pago...","success"),window.setTimeout(()=>{window.location.href=i},250)}catch(e){const t="AbortError"===e?.name?"El servidor demoró en responder. Probá nuevamente.":"No pudimos iniciar el pago en este momento.";setConfirmFeedback("AbortError"===e?.name?t:e?.message||t,"error"),disablePayButton(!1,"Confirmar y pagar"),confirmState.processing=!1}}else setConfirmFeedback("No pudimos validar el envío. Revisá tus datos y reintentá.","error")}function redirectWithDelay(e,t){setConfirmFeedback(t,"error"),window.setTimeout(()=>{window.location.href=e},1200)}async function initConfirmationStep(){if(!String(window.location.pathname||"").toLowerCase().includes("confirmacion"))return;if(confirmState.cart=await hydrateCartItems(sanitizeCart(getStoredCart())),0===confirmState.cart.length)return void redirectWithDelay("/tienda","Tu carrito está vacío. Te llevamos a la tienda.");const{normalized:e,missing:t}=getMissingShippingFields(getStoredShippingData());if(t.length>0)return void redirectWithDelay("/datos-envio","Faltan datos de envío para continuar. Completá el paso 1.");confirmState.shippingData=e,renderCartItems(confirmState.cart),renderShippingData(confirmState.shippingData);const i=getSubtotal(confirmState.cart);renderTotals(i,0),renderShippingLabel("Calculando costo de envío..."),setConfirmFeedback("Validando costo de envío por código postal...","loading"),requestShippingQuote(confirmState.shippingData.postalCode,confirmState.cart).then(e=>{confirmState.shippingQuote=e,renderTotals(i,e.shippingCost),renderShippingLabel(`${e.shippingLabel}. Plazos: 48/72 hs (stock) o 10-20 días hábiles (bajo pedido).`),setConfirmFeedback("Todo listo. Podés confirmar y pagar.","success"),disablePayButton(!1,"Confirmar y pagar")}).catch(e=>{renderTotals(i,null),renderShippingLabel("No pudimos calcular el envío automáticamente para este CP.");const t="AbortError"===e?.name?"La cotización tardó demasiado. Verificá tu conexión y reintentá.":"No pudimos calcular el envío.";setConfirmFeedback("AbortError"===e?.name?t:e?.message||t,"error"),disablePayButton(!0,"Confirmar y pagar")});const r=document.getElementById("confirm-and-pay-btn");r&&(r.disabled=!0,r.addEventListener("click",()=>{handleConfirmAndPay()}))}document.addEventListener("DOMContentLoaded",()=>{initConfirmationStep().catch(()=>{redirectWithDelay("/tienda","No pudimos cargar la confirmación. Te llevamos a la tienda.")})});